#!python

import os
import subprocess
import sys
from pathlib import Path

from importlib_resources import files
from pdp_kafka_reader.conf import SPARK_AVRO_JAR_PATH

PYTHON_EXE = sys.executable
KAFKA_READER: Path = files("pdp_kafka_reader").joinpath("kafka_reader.py")

cmd = [
    "spark-submit",
    "--master",
    "local",
    "--jars",
    str(SPARK_AVRO_JAR_PATH),
    str(KAFKA_READER),
] + sys.argv[1:]

env = dict(
    PYSPARK_DRIVER_PYTHON=PYTHON_EXE,
    PYSPARK_PYTHON=PYTHON_EXE,
    **os.environ,
)

subprocess.run(cmd, check=True, env=env)
