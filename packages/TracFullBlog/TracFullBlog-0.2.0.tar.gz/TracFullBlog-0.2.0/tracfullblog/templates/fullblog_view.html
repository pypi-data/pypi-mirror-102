{# Copyright (C) 2007-2020 CodeResort.com - BV Network AS (simon-code@bvnetwork.no)

  This software is licensed as described in the file COPYING, which
  you should have received as part of this distribution.
#}
# extends 'layout.html'
<!DOCTYPE html>
<html>
  # include "macros.html" ignore missing
  <head>
    <title>
      # block title
      Blog${blog_post and ': ' + blog_post.title or req.args.get('blog_path') and blog_list_title and ': ' + blog_list_title}
      ${ super() }
      # endblock title
    </title>
    # block head
    ${ super() }
    # if blog_post_list:
    <meta name="ROBOTS" content="NOINDEX" />
    # endif
    # if blog_post and blog_post.version:
    <link rel="alternate" href="${href.blog(format='rss')}"
          type="application/rss+xml" class="rss" title="RSS Feed" />
    # endif
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").filter("[id]").addAnchor("Link here");
        $("#comment").autoPreview("${href.wiki_render()}", {
            realm: "blog",
          }, $("#preview").showOnPreview());
      });
    </script>
    # endblock
  </head>
  <body>
  # block content

  # import "fullblog_macro_post.html" as render with context

    <div id="content" class="blog wiki">

      # include "fullblog_sidebar.html"

      <div id="blog-main">

        <!--! View single post with comments -->
        # if blog_post and blog_post.version:
          ${render.render_blog_post(blog_post)}

          <!--! Buttons for edit etc. -->
          # if not list_mode and ('BLOG_MODIFY_ALL' in perm(blog_post.resource) or (blog_post.author==perm.username and 'BLOG_MODIFY_OWN' in perm(blog_post.resource))):
            <div class="buttons">
              <form method="get" action="${href.blog('edit', blog_post.name)}">
                <div>
                  <input type="submit" value="${_('Edit post')}" accesskey="e" />
                </div>
              </form>

              # if attach_file_form:
                  ${attach_file_form(blog_attachments)}
              # else:
              #    set alist = blog_attachments
                # include "attach_file_form.html"
              # endif

              # if 'BLOG_DELETE' in perm(blog_post.resource):
              <form method="get" action="${href.blog('delete', blog_post.name)}">
                <div>
                  <input type="submit" value="${_('Delete...')}"
                      accesskey="d" />
                </div>
              </form>
              # endif
            </div>
          # endif

          <!--! List attachments -->
            # if list_of_attachments:
              ${list_of_attachments(blog_attachments, compact=True)}
            # else:
            #   set alist = blog_attachments
            #   set compact = True
            #   include "list_of_attachments.html"
            # endif

          <!--! View comments -->
          # with
          #    set blog_comments = blog_post.get_comments()
          <div id="comments">
            <h2 id="comment-header">Comments</h2>
            # if blog_comments:
              # for comment in blog_comments:
            <div class="blog-comment ${loop.cycle('odd', 'even')}" id="comment-${comment.number}">
                # if 'BLOG_DELETE' in perm(blog_post.resource):
                <span class="metainfo blog-comment-delete">
                  <a href="${href.blog('delete', blog_post.name, comment=comment.number)}">Delete comment</a>
                </span>
                # endif
                <div class="comment-info">
                    <a href="${req.href.blog(comment.post_name)}#comment-${to_unicode(comment.number)}">
                      ${comment.number}.</a>
                    ${authorinfo(comment.author)} --
                    ${pretty_dateinfo and pretty_dateinfo(comment.time) or format_datetime(comment.time)}</div>
                <div class="comment-body">${wiki_to_html(context, comment.comment)}</div>
            </div>
            # endfor
            # else:
            <p>No comments.</p>
            # endif
          </div>
          # endwith

          <!--! Add new comment -->
          #if 'BLOG_COMMENT' in perm(blog_post.resource):
          <div id="newcomment">
            <h3>Add New Comment</h3>
            <form action="${req.href.blog(blog_post.name)}#preview" method="post">
              ${jmacros.form_token_input()}
              <fieldset>
                  <div class="field">
                    <label for="comment">Comment (you may use
                      <a tabindex="42" href="${href.wiki('WikiFormatting')}">WikiFormatting</a>
                      here):
                    </label><br />
                    <textarea class="wikitext trac-fullwidth" id="comment"
                              name="comment" cols="80" rows="8">${blog_comment and blog_comment.comment or ''}</textarea>
                  </div>
                #if req.chrome.warnings:
                  <a href="#warning">(Warnings)</a>
                #endif
                  <div id="preview" class="trac-content trac-draft"
                       style="${'' if comment_preview else 'display:none'}">
                    # if comment_preview:
                      ${wiki_to_html(context, blog_comment.comment)}
                    # endif
                  </div>
                <div class="field">
                  <label for="author">Email or username:</label>
                    <br />
                    <input id="author" type="text"
                        name="author" size="30"
                        value="${(blog_comment and blog_comment.author)
                                 or get_reporter_id(req)}" />
                </div>
                <div class="buttons">
                  <input type="submit" name="previewcomment" value="Preview comment" />
                  <input size="30" type='submit' name="submitcomment"
                      value="Add comment" />
                  <input type="hidden" name="action" value="comment" />
                  <input type="submit" name="cancelcomment" value="Cancel" />
                </div>
              </fieldset>
            </form>
          </div>
          # endif

        # endif
        <!--! Single blog post rendering end -->

        <!--! Requesting a non-existing blog post -->
        # if blog_post and not blog_post.version:
        <p>
          No blog post named '${blog_post.name}'.
            <a href="${req.href.blog('create', name=blog_post.name)}"
              class="button">
              Create it!
            </a>
        </p>
        # endif

        <!--! View list of posts -->
          <div class="blog-list-title">${blog_list_title}</div>
          # if blog_post_list and not len(blog_post_list):
          <p>
            No blog posts available.
          </p>
          # endif
          # for blog_post in blog_post_list:
            ${render.render_blog_post(blog_post, list_mode=True)}
          # endfor

      </div>

    </div>
  # endblock content
  </body>
</html>
